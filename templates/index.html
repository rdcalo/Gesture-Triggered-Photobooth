<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth - VisionBooth</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #f1f1f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 60px;
            background-color: #f1f1f1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            color: #101b40;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .logo span {
            display: block;
            line-height: 1.2;
        }

        .nav-menu {
            background-color: white;
            border: 3px solid #101b40;
            border-radius: 50px;
            padding: 8px;
            display: flex;
            gap: 5px;
            box-shadow: 0 4px 15px rgba(16, 27, 64, 0.1);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .nav-btn {
            padding: 12px 35px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #101b40;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn.active {
            background-color: #101b40;
            color: white;
        }

        .nav-btn:hover:not(.active) {
            background-color: #f1f1f1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 60px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .status-title {
            font-size: 2.5em;
            font-weight: 600;
            color: #101b40;
            margin-bottom: 30px;
            text-align: center;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 900px;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 30px;
            border: 6px solid #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #video, #processedFrame {
            width: 100%;
            height: auto;
            display: block;
        }

        #processedFrame {
            display: none;
        }

        .countdown-display {
            font-size: 6em;
            font-weight: 700;
            color: #101b40;
            text-align: center;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-section {
            text-align: center;
            margin: 20px 0;
        }

        .info-text {
            font-size: 1.5em;
            color: #101b40;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .action-btn {
            padding: 15px 50px;
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            background-color: #101b40;
            border: 3px solid #101b40;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 27, 64, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .action-btn:hover {
            background-color: white;
            color: #101b40;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 27, 64, 0.4);
        }

        .gesture-display {
            font-size: 1.2em;
            color: #000;
            margin-top: 15px;
        }

        .progress-bar-container {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ddd;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: #101b40;
            transition: width 0.3s ease;
            border-radius: 50px;
        }

        #canvas {
            display: none;
        }

        .strip-preview {
            display: none;
            text-align: center;
            width: 100%;
        }

        .strip-preview.show {
            display: block;
        }

        .strip-preview h2 {
            font-size: 2.5em;
            color: #101b40;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .strip-preview img {
            max-width: 400px;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            margin: 20px 0;
            border: 5px solid #101b40;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .download-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            background-color: #101b40;
            border: 3px solid #101b40;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 27, 64, 0.3);
        }

        .download-btn:hover {
            background-color: white;
            color: #101b40;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 27, 64, 0.4);
        }

        .performance-info {
            font-size: 0.85em;
            color: #999;
            margin-top: 15px;
            text-align: center;
        }

        /* Hide elements initially */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 20px;
                padding: 20px 30px;
            }

            .nav-menu {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }

            .main-content {
                padding: 30px 20px;
            }

            .status-title {
                font-size: 1.8em;
            }

            .countdown-display {
                font-size: 4em;
                min-height: 80px;
            }

            .info-text {
                font-size: 1.2em;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="logo">
            <span>VISION</span>
            <span>BOOTH</span>
        </div>
        <div class="nav-menu">
            <a href="{{ url_for('home') }}" class="nav-btn">HOME</a>
            <a href="{{ url_for('guide') }}" class="nav-btn active">GUIDE</a>
            <a href="{{ url_for('index') }}" class="nav-btn">PHOTOBOOTH</a>
            <a href="{{ url_for('about') }}" class="nav-btn">ABOUT</a>

        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="status-title" id="statusTitle">Set your timer using your fingers</div>

        <div id="videoContainer">
            <video id="video" autoplay playsinline></video>
            <img id="processedFrame" alt="Processed frame">
        </div>

        <div class="countdown-display" id="countdownDisplay"></div>

        <div class="info-section">
            <div class="info-text" id="infoText">Do a thumbs up when you're ready!</div>
            <button class="action-btn hidden" id="resetBtn" onclick="resetSession()">Make a fist to change timer</button>
        </div>

        <div class="progress-bar-container hidden" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="gesture-display" id="gestureDisplay">Gesture detected: None</div>

        <div class="strip-preview" id="stripPreview">
            <h2>üéâ Your Photo Strip is Ready!</h2>
            <img id="stripImage" src="" alt="Photo strip">
            <div class="button-group">
                <button class="download-btn" onclick="downloadStrip()">üì• Download Strip</button>
                <button class="download-btn" onclick="startNewStrip()">üîÑ Take New Strip</button>
            </div>
        </div>

        <div class="performance-info" id="performanceInfo">FPS: --</div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const socket = io();
        const video = document.getElementById('video');
        const processedFrame = document.getElementById('processedFrame');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusTitle = document.getElementById('statusTitle');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const infoText = document.getElementById('infoText');
        const resetBtn = document.getElementById('resetBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const gestureDisplay = document.getElementById('gestureDisplay');
        const performanceInfo = document.getElementById('performanceInfo');
        const stripPreview = document.getElementById('stripPreview');
        const stripImage = document.getElementById('stripImage');

        let canSend = true;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let currentState = 'PROMPT_TIMER';
        let processingTimeout = null;
        let lastFrameTime = 0;
        let currentStripFilename = null;
        let lastCaptureTriggered = false;

        const SCALE_FACTOR = 0.35;
        const JPEG_QUALITY = 0.5;
        const FRAME_INTERVAL = 200;
        const RESPONSE_TIMEOUT = 2000;

        // Access webcam
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                facingMode: 'user'
            } 
        })
        .then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth * SCALE_FACTOR;
                canvas.height = video.videoHeight * SCALE_FACTOR;
                
                console.log(`üìπ Video Resolution: ${video.videoWidth}x${video.videoHeight}`);
                console.log(`üîç Detection Resolution: ${canvas.width}x${canvas.height}`);
                
                startSending();
            };
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
            statusTitle.textContent = 'Error: Cannot access camera';
        });

        function startSending() {
            setInterval(() => {
                const now = Date.now();
                
                if (now - lastFrameTime < FRAME_INTERVAL) {
                    return;
                }
                
                if (canSend) {
                    canSend = false;
                    lastFrameTime = now;
                    
                    if (processingTimeout) {
                        clearTimeout(processingTimeout);
                    }
                    
                    processingTimeout = setTimeout(() => {
                        console.warn('‚ö†Ô∏è Backend timeout, forcing reset');
                        canSend = true;
                    }, RESPONSE_TIMEOUT);
                    
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                    
                    socket.emit('video_frame', { image: imageData });
                    updateFPS();
                }
            }, 50);
        }

        function updateFPS() {
            frameCount++;
            const now = Date.now();
            const elapsed = now - lastFpsUpdate;
            
            if (elapsed >= 1000) {
                const fps = Math.round((frameCount / elapsed) * 1000);
                performanceInfo.textContent = `FPS: ${fps} | Detection: ${canvas.width}x${canvas.height} | Capture: ${video.videoWidth}x${video.videoHeight}`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        socket.on('state_update', (data) => {
            if (processingTimeout) {
                clearTimeout(processingTimeout);
                processingTimeout = null;
            }
            
            canSend = true;
            
            const stateChanged = (currentState !== data.state);
            currentState = data.state;
            
            if (stateChanged && currentState !== 'CAPTURE_DONE') {
                lastCaptureTriggered = false;
            }
            
            if (data.trigger_capture === true && !lastCaptureTriggered) {
                console.log('üì∏ Capture triggered by state update');
                lastCaptureTriggered = true;
                setTimeout(() => capturePhoto(), 100);
            }
            
            if (currentState !== 'COUNTDOWN') {
                processedFrame.src = data.frame;
                processedFrame.style.display = 'block';
                video.style.display = 'none';
            } else {
                processedFrame.style.display = 'none';
                video.style.display = 'block';
            }
            
            if (data.gesture) {
                gestureDisplay.textContent = `Gesture detected: ${data.gesture}`;
            } else {
                gestureDisplay.textContent = 'Gesture detected: None';
            }
            
            updateStatus(data);
        });

        function updateStatus(data) {
            const { state, timer_value, countdown: countdownValue, streak_progress, capture_count, total_captures } = data;
            
            countdownDisplay.textContent = '';
            progressContainer.classList.add('hidden');
            resetBtn.classList.add('hidden');
            
            switch(state) {
                case 'PROMPT_TIMER':
                    statusTitle.textContent = 'Set your timer using your fingers';
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    break;
                    
                case 'DETECTING_FINGERS':
                    statusTitle.textContent = 'Hold steady...';
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    if (streak_progress) {
                        progressContainer.classList.remove('hidden');
                        const percent = (streak_progress.current / streak_progress.required) * 100;
                        progressFill.style.width = percent + '%';
                    }
                    break;
                    
                case 'TIMER_SET':
                case 'AWAIT_THUMBS_UP':
                    statusTitle.textContent = `Timer set to ${timer_value} seconds`;
                    infoText.textContent = 'Do a thumbs up when you\'re ready!';
                    resetBtn.classList.remove('hidden');
                    if (streak_progress) {
                        progressContainer.classList.remove('hidden');
                        const percent = (streak_progress.current / streak_progress.required) * 100;
                        progressFill.style.width = percent + '%';
                    }
                    break;
                    
                case 'COUNTDOWN':
                    if (countdownValue !== null && countdownValue !== undefined) {
                        if (countdownValue > 0) {
                            statusTitle.textContent = '';
                            countdownDisplay.textContent = countdownValue;
                            infoText.textContent = 'Pose and hold still! Taking your photos!';
                        } else {
                            statusTitle.textContent = '';
                            countdownDisplay.textContent = 'üì∏';
                            infoText.textContent = 'Smile!';
                        }
                    }
                    resetBtn.classList.remove('hidden');
                    break;
                    
                case 'CAPTURE_DONE':
                    if (capture_count < total_captures) {
                        statusTitle.textContent = `Photo ${capture_count}/${total_captures} captured!`;
                        infoText.textContent = 'Get ready for next photo...';
                    } else {
                        statusTitle.textContent = 'Creating your photo strip...';
                        infoText.textContent = 'Almost done!';
                    }
                    break;
            }
        }

        function capturePhoto() {
            console.log('üì∏ Capture photo function called');
            
            try {
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const captureCtx = captureCanvas.getContext('2d');
                
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                const imageData = captureCanvas.toDataURL('image/png');
                
                console.log(`‚úÖ Image captured at ${captureCanvas.width}x${captureCanvas.height}`);
                
                socket.emit('save_photo', { image: imageData });
                console.log('üì§ Sent photo to server for saving\n');
            } catch (error) {
                console.error('‚ùå Error capturing photo:', error);
            }
        }

        socket.on('strip_ready', (data) => {
            console.log('üéâ Strip ready:', data.filename);
            currentStripFilename = data.filename;
            
            stripImage.src = `/${data.filename}`;
            stripPreview.classList.add('show');
            
            document.getElementById('videoContainer').style.display = 'none';
            statusTitle.style.display = 'none';
            countdownDisplay.style.display = 'none';
            infoText.style.display = 'none';
            resetBtn.style.display = 'none';
            gestureDisplay.style.display = 'none';
            progressContainer.style.display = 'none';
            performanceInfo.style.display = 'none';
        });

        socket.on('photo_received', (data) => {
            console.log(`‚úÖ Photo ${data.count}/${data.total} acknowledged by server`);
        });

        socket.on('photo_error', (data) => {
            console.error('‚ùå Photo error:', data.error);
            statusTitle.textContent = `Error: ${data.error}`;
            infoText.textContent = 'Please try again';
        });

        function downloadStrip() {
            if (currentStripFilename) {
                const link = document.createElement('a');
                link.href = `/${currentStripFilename}`;
                link.download = currentStripFilename.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log('üì• Downloading strip');
            }
        }

        function startNewStrip() {
            stripPreview.classList.remove('show');
            
            document.getElementById('videoContainer').style.display = 'block';
            statusTitle.style.display = 'block';
            countdownDisplay.style.display = 'flex';
            infoText.style.display = 'block';
            gestureDisplay.style.display = 'block';
            performanceInfo.style.display = 'block';
            
            console.log('üîÑ Starting new strip');
        }

        function resetSession() {
            // This is handled by the fist gesture
            console.log('Reset handled by fist gesture');
        }

        socket.on('connected', (data) => {
            console.log('‚úÖ Connected to server. Session:', data.session);
        });

        socket.on('disconnect', () => {
            console.warn('‚ö†Ô∏è Disconnected from server');
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå Connection error:', error);
        });

        socket.on('error', (error) => {
            console.error('‚ùå Socket error:', error);
        });
    </script>
</body>
</html>